version: 1.0
runtime: ruby31

build:
  commands:
    build:
      - echo "Installing dependencies..."
      - bundle install --deployment --without development test
      - echo "Precompiling assets..."
      - bundle exec rails assets:precompile RAILS_ENV=production
      - echo "Setting up database..."
      - bundle exec rails db:create RAILS_ENV=production || true
      - bundle exec rails db:migrate RAILS_ENV=production
    pre-build:
      - echo "Installing system packages..."
  env:
    - name: RAILS_ENV
      value: production
    - name: NODE_ENV
      value: production

run:
  runtime-version: ruby-3.1.0
  command: bundle exec rails server -e production -p 8080 -b 0.0.0.0
  network:
    port: 8080
  env:
    - name: RAILS_ENV
      value: production
    - name: RAILS_LOG_TO_STDOUT
      value: "true"
    - name: RAILS_SERVE_STATIC_FILES
      value: "true"
    - name: PORT
      value: "8080"
    - name: CORS_ORIGINS
      value: "https://yourdomain.com,https://www.yourdomain.com"
  secrets:
    - name: DATABASE_URL
      value_from: "arn:aws:secretsmanager:us-east-1:123456789012:secret:rails-app/database-url-AbCdEf"
    - name: SECRET_KEY_BASE
      value_from: "arn:aws:secretsmanager:us-east-1:123456789012:secret:rails-app/secret-key-base-XyZ123"
    - name: REDIS_URL
      value_from: "arn:aws:secretsmanager:us-east-1:123456789012:secret:rails-app/redis-url-MnOpQr"
    - name: API_KEY
      value_from: "arn:aws:secretsmanager:us-east-1:123456789012:secret:rails-app/api-key-StUvWx"
    - name: JWT_SECRET
      value_from: "arn:aws:secretsmanager:us-east-1:123456789012:secret:rails-app/jwt-secret-GhIjKl"