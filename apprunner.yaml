version: 1.0
runtime: ruby31

build:
  env:
    - name: RAILS_ENV
      value: production
    - name: BUNDLER_WITHOUT # Use BUNDLER_WITHOUT instead of modifying config
      value: "development:test"
    # No need to explicitly install Bundler here
  commands:
    # Use the correct `commands` structure without the extra `build` key
    - set -euxo pipefail
    - bundle config set --local path vendor/bundle
    - bundle install --jobs 4 --retry 3 --verbose
    # Add database migration and asset precompilation steps
    - bundle exec rails assets:precompile
    - bundle exec rails db:migrate

run:
  command: bundle exec puma -C config/puma.rb
  network:
    port: 8080
    env: APP_PORT
  env:
    - name: RACK_ENV
      value: production
    - name: RAILS_ENV
      value: production
    - name: STAGE
      value: "true"
    - name: RAILS_LOG_TO_STDOUT
      value: "true"
    - name: RAILS_SERVE_STATIC_FILES
      value: "true"
    - name: RAILS_LOG_LEVEL
      value: "info"
    - name: WEB_CONCURRENCY
      value: "1"
    - name: RAILS_MAX_THREADS
      value: "5"

  secrets:
    # Secrets Manager (ARN completo o nombre):
    - name: SECRET_KEY_BASE
      value-from: arn:aws:secretsmanager:us-east-1:211125514217:secret:properlia/rails/secret_key_base-6GKC6m
    - name: RAILS_MASTER_KEY
      value-from: arn:aws:secretsmanager:us-east-1:211125514217:secret:properlia/rails/master_key-xZP2Wb

    # SSM Parameter Store (ARN o nombre del par√°metro):
    - name: DATABASE_URL
      value-from: arn:aws:secretsmanager:us-east-1:211125514217:secret:properlia/stage/postgres-YaL3cv
    # Ejemplos alternativos si no usas DATABASE_URL:
    # - name: DB_HOST
    #   value-from: arn:aws:ssm:REGION:ACCOUNT:parameter/proper/db/HOST
    # - name: DB_USER
    #   value-from: arn:aws:ssm:REGION:ACCOUNT:parameter/proper/db/USER
    # - name: DB_PASS
    #   value-from: arn:aws:ssm:REGION:ACCOUNT:parameter/proper/db/PASS
    # - name: DB_NAME
    #   value-from: arn:aws:ssm:REGION:ACCOUNT:parameter/proper/db/NAME
    # - name: DB_SSLMODE
    #   value-from: arn:aws:ssm:REGION:ACCOUNT:parameter/proper/db/SSLMODE

  # (Opcional) Comandos pre-run si necesitas ajustar algo en la imagen de runtime
  # pre-run:
  #   - echo "Pre-run adjustments"
